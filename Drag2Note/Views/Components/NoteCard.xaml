<UserControl x:Class="Drag2Note.Views.Components.NoteCard"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Drag2Note.Views.Components"
             xmlns:models="clr-namespace:Drag2Note.Models"
             mc:Ignorable="d" 
             d:DesignHeight="120" d:DesignWidth="360"
             Margin="0,0,0,12"
             MinHeight="110"
             MouseDoubleClick="Grid_MouseDoubleClick">
    <Border x:Name="CardBorder" CornerRadius="10" Padding="15" BorderThickness="1"
            MouseLeftButtonDown="Grid_MouseLeftButtonDown" Focusable="True">
        <Border.Style>
            <Style TargetType="Border">
                <Setter Property="Background" Value="{DynamicResource WindowBackground}"/>
                <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                <Style.Triggers>
                    <!-- Type specific backgrounds -->
                    <DataTrigger Binding="{Binding Type}" Value="{x:Static models:NoteType.Note}">
                        <Setter Property="Background" Value="{DynamicResource CardNoteBackground}"/>
                        <Setter Property="BorderBrush" Value="{DynamicResource CardNoteBorder}"/>
                    </DataTrigger>
                    <DataTrigger Binding="{Binding Type}" Value="{x:Static models:NoteType.Todo}">
                        <Setter Property="Background" Value="{DynamicResource CardTodoBackground}"/>
                        <Setter Property="BorderBrush" Value="{DynamicResource CardTodoBorder}"/>
                    </DataTrigger>
                    <!-- Completed Todo State -->
                    <DataTrigger Binding="{Binding Status}" Value="{x:Static models:TodoStatus.Completed}">
                        <Setter Property="Background" Value="{DynamicResource CardCompletedBackground}"/>
                        <Setter Property="Opacity" Value="0.6"/>
                    </DataTrigger>
                    <!-- Selection state -->
                    <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True">
                        <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
                        <Setter Property="BorderThickness" Value="1.5"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>
        
        <Grid MouseLeftButtonDown="Grid_MouseLeftButtonDown">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/> <!-- Right side for Todo circle -->
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="1*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <Grid Grid.Row="0" Margin="0,0,0,6">
                <!-- View Mode Title -->
                <TextBlock FontWeight="Bold" FontSize="16" Foreground="{DynamicResource TextPrimary}" Cursor="Hand"
                           Text="{Binding CustomTitle, TargetNullValue='Untitled'}"
                           HorizontalAlignment="Left"
                           MouseLeftButtonDown="Title_MouseLeftButtonDown"
                           FocusVisualStyle="{x:Null}">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True"/>
                                        <Condition Binding="{Binding DataContext.IsRenaming, RelativeSource={RelativeSource AncestorType=Window}}" Value="True"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- Edit Mode Title -->
                <TextBox FontWeight="Bold" FontSize="16" Foreground="{DynamicResource TextPrimary}"
                         Text="{Binding DataContext.RenamingText, RelativeSource={RelativeSource AncestorType=Window}, UpdateSourceTrigger=PropertyChanged}"
                         x:Name="TitleEditor"
                         Background="{DynamicResource WindowBackground}" BorderBrush="{DynamicResource PrimaryBrush}" BorderThickness="1"
                         Padding="2,0" Margin="-3,-2" MinHeight="24"
                         LostFocus="TitleEditor_LostFocus"
                         IsVisibleChanged="TitleEditor_IsVisibleChanged"
                         KeyDown="TitleEditor_KeyDown"
                         FocusVisualStyle="{x:Null}">
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True"/>
                                        <Condition Binding="{Binding DataContext.IsRenaming, RelativeSource={RelativeSource AncestorType=Window}}" Value="True"/>
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible"/>
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                    <TextBox.InputBindings>
                        <KeyBinding Key="Enter" Command="{Binding DataContext.SaveRenameCommand, RelativeSource={RelativeSource AncestorType=Window}}"/>
                    </TextBox.InputBindings>
                </TextBox>
            </Grid>

            <!-- Preview Content -->
            <TextBlock Grid.Row="1" Grid.Column="0" Text="{Binding PreviewText}" Foreground="{DynamicResource TextSecondary}" TextWrapping="Wrap" MaxHeight="45" TextTrimming="CharacterEllipsis"/>

            <!-- Todo Checkbox (Custom Styled) -->
            <CheckBox Grid.Row="0" Grid.Column="1" 
                      VerticalAlignment="Top" Margin="10,2,0,0"
                      Command="{Binding DataContext.ToggleTodoStatusCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                      CommandParameter="{Binding}"
                      FocusVisualStyle="{x:Null}">
                <CheckBox.Style>
                    <Style TargetType="CheckBox">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="CheckBox">
                                    <Border x:Name="circle" Width="20" Height="20" CornerRadius="10" 
                                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="2" Background="{DynamicResource WindowBackground}" Cursor="Hand">
                                        <Path x:Name="checkMark" Data="M 4,10 L 8,14 L 16,6" Stroke="#38A169" 
                                              StrokeThickness="2.5" Visibility="Collapsed"
                                              HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsChecked" Value="True">
                                            <Setter TargetName="circle" Property="Background" Value="{DynamicResource TagBackground}"/>
                                            <Setter TargetName="circle" Property="BorderBrush" Value="#38A169"/>
                                            <Setter TargetName="checkMark" Property="Visibility" Value="Visible"/>
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter TargetName="circle" Property="BorderBrush" Value="#A0AEC0"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Type}" Value="{x:Static models:NoteType.Todo}">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                            <!-- Sync Checkbox with Status -->
                            <DataTrigger Binding="{Binding Status}" Value="{x:Static models:TodoStatus.Completed}">
                                <Setter Property="IsChecked" Value="True"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </CheckBox.Style>
            </CheckBox>

            <!-- Footer: Date & Tags (Interactive Tag Bar) - Multi-line Wrap Layout -->
            <Border Grid.Row="2" Grid.ColumnSpan="2" Margin="0,8,0,0"
                    x:Name="TagBarContainer"
                    CornerRadius="6" Padding="6,4"
                    BorderThickness="1" BorderBrush="Transparent"
                    HorizontalAlignment="Stretch"
                    Background="Transparent"
                    MinHeight="32"
                    VerticalAlignment="Bottom"
                    AllowDrop="True"
                    Drop="TagBarContainer_Drop"
                    MouseLeftButtonDown="TagBarContainer_MouseLeftButtonDown">
                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="BorderBrush" Value="{DynamicResource SelectionBackground}"/>
                                <Setter Property="Background" Value="#0D000000"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <!-- WrapPanel for auto-wrapping tags -->
                <WrapPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="-7,0,0,0">
                    <!-- Fixed Gray Date Tag (from CreatedAtString, not from Tags array) -->
                    <Border Background="{DynamicResource HeaderBackground}" 
                            CornerRadius="4" 
                            Padding="6,2" 
                            Margin="0,2,4,2" 
                            Height="20"
                            BorderThickness="1" 
                            BorderBrush="Transparent">
                        <TextBlock Text="{Binding CreatedAtString}" 
                                   Foreground="{DynamicResource TextSecondary}" 
                                   FontSize="10" 
                                   VerticalAlignment="Center"/>
                    </Border>

                    <!-- Custom Tags (user-created only, no auto date tags) -->
                    <ItemsControl x:Name="TagsItemsControl" ItemsSource="{Binding Tags}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border x:Name="TagItem" 
                                        Background="{DynamicResource TagBackground}" 
                                        CornerRadius="4" 
                                        Padding="6,2" 
                                        Margin="0,2,4,2" 
                                        Height="20"
                                        BorderThickness="1" 
                                        BorderBrush="Transparent" 
                                        Cursor="SizeAll"
                                        MouseLeftButtonDown="TagItem_MouseLeftButtonDown">
                                    <TextBlock Text="{Binding}" 
                                               Foreground="{DynamicResource TagForeground}" 
                                               FontSize="10" 
                                               VerticalAlignment="Center"/>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Add Tag Interface (follows last tag) -->
                    <Grid x:Name="AddTagArea" MaxHeight="24" Margin="0,2,0,2" VerticalAlignment="Center">
                        <!-- '+' Button -->
                        <Button x:Name="BtnShowAddTag" Content="+" 
                                FontSize="12" Foreground="#94A3B8"
                                Background="Transparent" BorderThickness="0"
                                Width="24" Height="20" Cursor="Hand"
                                Click="BtnShowAddTag_Click"
                                FocusVisualStyle="{x:Null}">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Grid Background="Transparent">
                                        <TextBlock Text="{TemplateBinding Content}" 
                                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                                   Foreground="{TemplateBinding Foreground}"/>
                                    </Grid>
                                </ControlTemplate>
                            </Button.Template>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Setter Property="VerticalAlignment" Value="Center"/>
                                    <Style.Triggers>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding IsMouseOver, ElementName=TagBarContainer}" Value="True"/>
                                                <Condition Binding="{Binding Visibility, ElementName=InlineTagEditor}" Value="Collapsed"/>
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </MultiDataTrigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Foreground" Value="{DynamicResource PrimaryBrush}"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>

                        <!-- Inline TextBox -->
                        <TextBox x:Name="InlineTagEditor" 
                                 Visibility="Collapsed"
                                 Width="70" Height="20" FontSize="10"
                                 VerticalContentAlignment="Center"
                                 Padding="5,0"
                                 Background="{DynamicResource SearchBackground}"
                                 Foreground="{DynamicResource TextPrimary}"
                                 CaretBrush="{DynamicResource PrimaryBrush}"
                                 BorderBrush="{DynamicResource BorderBrush}"
                                 LostFocus="InlineTagEditor_LostFocus"
                                 KeyDown="InlineTagEditor_KeyDown"
                                 FocusVisualStyle="{x:Null}"/>
                    </Grid>
                </WrapPanel>
            </Border>
        </Grid>
    </Border>
</UserControl>
